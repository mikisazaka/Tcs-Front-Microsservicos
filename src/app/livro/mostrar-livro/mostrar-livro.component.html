<div *ngIf="livro$ | async as livro;" class="pagina-container">

  <div class="secao-detalhes-e-form" style="background-color: #F7F1ED;">

    <div class="imagem-livro">
      <img [src]="apiBaseUrl + '/images/' + livro.imagePath" [alt]="'Capa do livro ' + livro.title" />
    </div>

    <div class="infos-e-form-container">

      <div class="bloco-info-livro">
        <p class="titulo-livro">{{ livro.title }}</p>
        <p class="autor-livro">{{ livro.author }}</p>

        <div class="flex items-center mt-3">
          <ng-container *ngFor="let starType of getStarArray(averageRating)">
            <div [ngSwitch]="starType">
              <svg *ngSwitchCase="'full'" class="w-6 h-6 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M13.849 4.22c-.684-1.626-3.014-1.626-3.698 0L8.397 8.387l-4.552.361c-1.775.14-2.495 2.331-1.142 3.477l3.468 2.937-1.06 4.392c-.413 1.713 1.472 3.067 2.992 2.149L12 19.35l3.897 2.354c1.52.918 3.405-.436 2.992-2.15l-1.06-4.39 3.468-2.938c1.353-1.146.633-3.336-1.142-3.477l-4.552-.36-1.754-4.17Z" />
              </svg>
              <svg *ngSwitchCase="'half'" class="w-6 h-6 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                <path fill-rule="evenodd"
                  d="M13 4.024v-.005c0-.053.002-.353-.217-.632a1.013 1.013 0 0 0-1.176-.315c-.192.076-.315.193-.35.225-.052.05-.094.1-.122.134a4.358 4.358 0 0 0-.31.457c-.207.343-.484.84-.773 1.375a168.719 168.719 0 0 0-1.606 3.074h-.002l-4.599.367c-1.775.14-2.495 2.339-1.143 3.488L6.17 15.14l-1.06 4.406c-.412 1.72 1.472 3.078 2.992 2.157l3.94-2.388c.592-.359.958-.996.958-1.692v-13.6Zm-2.002 0v.025-.025Z"
                  clip-rule="evenodd" />
              </svg>
              <svg *ngSwitchCase="'empty'" class="w-6 h-6 text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M13.849 4.22c-.684-1.626-3.014-1.626-3.698 0L8.397 8.387l-4.552.361c-1.775.14-2.495 2.331-1.142 3.477l3.468 2.937-1.06 4.392c-.413 1.713 1.472 3.067 2.992 2.149L12 19.35l3.897 2.354c1.52.918 3.405-.436 2.992-2.15l-1.06-4.39 3.468-2.938c1.353-1.146.633-3.336-1.142-3.477l-4.552-.36-1.754-4.17Z" />
              </svg>
            </div>
          </ng-container>
        </div>
      </div>

      <div class="bloco-detalhes-adicionais grid">
        <span> Ano: {{ livro.publishedYear }} </span>
        <span> Páginas: {{ livro.pagesQuantity }} pág. </span>
        <span> Gênero: {{ livro.gender }} </span>
      </div>

      <div class="bloco-classificacao-e-like">
        <div [ngSwitch]="livro.contentRating">
          <span *ngSwitchCase="'LIVRE'" class="r-livre r">L</span>
          <span *ngSwitchCase="'DEZ'" class="r-10 r">10+</span>
          <span *ngSwitchCase="'DOZE'" class="r-12 r">12+</span>
          <span *ngSwitchCase="'QUATORZE'" class="r-14 r">14+</span>
          <span *ngSwitchCase="'DEZESSEIS'" class="r-16 r">16+</span>
          <span *ngSwitchCase="'DEZOITO'" class="r-18 r">18+</span>
          <p *ngSwitchDefault>Classificação não informada</p>
        </div>
        <div id="like-div" *ngIf="isLiked !== null">
          <svg *ngIf="!isLiked" (click)="onLikeClick(livro.id)" class="btn-i-like" fill="lightgray" viewBox="0 0 24 24">
            <path stroke="gray" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12.01 6.001C6.5 1 1 8 5.782 13.001L12.011 20l6.23-7C23 8 17.5 1 12.01 6.002Z" />
          </svg>
          <svg *ngIf="isLiked" (click)="onLikeClick(livro.id)" class="btn-i-like" fill="red" viewBox="0 0 24 24">
            <path stroke="red" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12.01 6.001C6.5 1 1 8 5.782 13.001L12.011 20l6.23-7C23 8 17.5 1 12.01 6.002Z" />
          </svg>
        </div>
        <div class="relative">
          <button id="dropdownList" #dropdownButton (click)="toggleDropdown()" data-dropdown-toggle="listRadio"
            class="h-12 w-12" style="cursor: pointer;">
            <img src="assets/images/add.png">
          </button>
          <div id="listRadio" #dropdownMenu
            class="absolute z-10 hidden w-48 border border-gray-300 bg-white divide-y divide-gray-100 rounded-lg shadow-sm dark:divide-gray-600">
            <ul class="p-3 space-y-3 text-sm text-gray-700 dark:text-gray-200" aria-labelledby="dropdownList">
              <li *ngFor="let stt of status">
                <div class="flex items-center">
                  <input [id]="stt.value" type="radio" [value]="stt.value" name="stt" required
                    [(ngModel)]="listaEscolhida" (change)="addLista()" class="w-4 h-4 text-orange-900 bg-gray-100 
                    border-gray-300 focus:ring-orange-900 focus:ring-2">
                  <label [for]="stt.value"
                    class="ms-2 text-sm font-medium text-gray-900">{{stt.label}}</label>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <div class="form-nova-review">
        <div class="flex gap-5">
          <div class="grid">
            <label>Dê uma nota geral para o livro <span style="color: red">*</span></label>
            <div class="flex" (mouseleave)="onMouseLeave()">
              <ng-container *ngFor="let star of stars">
                <span (mouseenter)="onStarHover(star)" (click)="setRating(star)" style="cursor: pointer">
                  <svg class="w-10 h-10" viewBox="0 0 24 24"
                    [attr.fill]="hoverRating >= star || rating >= star ? '#FDC700' : 'lightGray'">
                    <path
                      d="M13.849 4.22c-.684-1.626-3.014-1.626-3.698 0L8.397 8.387l-4.552.361c-1.775.14-2.495 2.331-1.142 3.477l3.468 2.937-1.06 4.392c-.413 1.713 1.472 3.067 2.992 2.149L12 19.35l3.897 2.354c1.52.918 3.405-.436 2.992-2.15l-1.06-4.39 3.468-2.938c1.353-1.146.633-3.336-1.142-3.477l-4.552-.36-1.754-4.17Z" />
                  </svg>
                </span>
              </ng-container>
            </div>
          </div>
          <div *ngIf="authService.isLoggedIn() && !authService.isAdmin()" class="grid gap-3">
            <div>
              <p style="font-size: 20px;">Enviar avaliação como <span style="color: red">*</span></p>
            </div>
            <div class="flex gap-5">
              <div>
                <p>{{authService.getUserName()}}</p>
                <input type="radio" name="username_review" value="{{authService.getUserName()}}" [(ngModel)]="username" style="cursor: pointer;">
              </div>
              <div>
                <p>Anônimo</p>
                <input type="radio" name="username_review" value="Anônimo" [(ngModel)]="username" style="cursor: pointer;">
              </div>
            </div>
          </div>
        </div>
        <div class="grid gap-1">
          <label for="input-titulo-review">Título da sua avaliação</label>
          <input type="text" [(ngModel)]="titulo" placeholder="Ex: Incrível!" id="input-titulo-review" />
        </div>
        <div class="grid gap-1">
          <label for="input-comentario-review">Sua avaliação <span style="color: red">*</span></label>
          <textarea [(ngModel)]="comentario" placeholder="Escreva aqui o que você achou do livro..."
            id="input-comentario-review"></textarea>
        </div>
        <div class="flex justify-center">
          <button id="btn-enviar-avaliacao" (click)="enviar()">AVALIAR</button>
        </div>
      </div>
    </div>
  </div>

  <div class="secao-avaliacoes">
    <div class="lista-reviews-container">
      <div *ngFor="let review of allReviews" class="review-card">
        <div class="flex justify-between items-center">
          <div class="flex gap-2">
            <svg class="w-6 h-6 text-gray-800 dark:text-white" style="background-color: #000; border-radius: 50%;"
            aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#fff"
            viewBox="0 0 24 24">
            <path fill-rule="evenodd"
              d="M12 4a4 4 0 1 0 0 8 4 4 0 0 0 0-8Zm-2 9a4 4 0 0 0-4 4v1a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-1a4 4 0 0 0-4-4h-4Z"
              clip-rule="evenodd" />
          </svg>
          <p>{{review.username}}</p>
          </div>
          <div *ngIf="authService.getUserId() == review.userId">
            <button style="background-color: red; border-radius: 50%; padding: .25rem; cursor: pointer;" (click)="delete(review.reviewId)">
              <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                <path stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 7h14m-9 3v8m4-8v8M10 3h4a1 1 0 0 1 1 1v3H9V4a1 1 0 0 1 1-1ZM6 7h12v13a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V7Z"/>
              </svg>              
            </button>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <p class="review-title">{{ review.title }}</p>
          <div class="flex items-center">
            <ng-container *ngFor="let starType of getStarArray(review.rating)">
              <div [ngSwitch]="starType">
                <svg *ngSwitchCase="'full'" class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M13.849 4.22c-.684-1.626-3.014-1.626-3.698 0L8.397 8.387l-4.552.361c-1.775.14-2.495 2.331-1.142 3.477l3.468 2.937-1.06 4.392c-.413 1.713 1.472 3.067 2.992 2.149L12 19.35l3.897 2.354c1.52.918 3.405-.436 2.992-2.15l-1.06-4.39 3.468-2.938c1.353-1.146.633-3.336-1.142-3.477l-4.552-.36-1.754-4.17Z" />
                </svg>
                <svg *ngSwitchCase="'half'" class="w-5 h-5 text-yellow-400" fill="currentColor" viewBox="0 0 24 24">
                  <path fill-rule="evenodd"
                    d="M13 4.024v-.005c0-.053.002-.353-.217-.632a1.013 1.013 0 0 0-1.176-.315c-.192.076-.315.193-.35.225-.052.05-.094.1-.122.134a4.358 4.358 0 0 0-.31.457c-.207.343-.484.84-.773 1.375a168.719 168.719 0 0 0-1.606 3.074h-.002l-4.599.367c-1.775.14-2.495 2.339-1.143 3.488L6.17 15.14l-1.06 4.406c-.412 1.72 1.472 3.078 2.992 2.157l3.94-2.388c.592-.359.958-.996.958-1.692v-13.6Zm-2.002 0v.025-.025Z"
                    clip-rule="evenodd" />
                </svg>
                <svg *ngSwitchCase="'empty'" class="w-5 h-5 text-gray-300" fill="currentColor" viewBox="0 0 24 24">
                  <path
                    d="M13.849 4.22c-.684-1.626-3.014-1.626-3.698 0L8.397 8.387l-4.552.361c-1.775.14-2.495 2.331-1.142 3.477l3.468 2.937-1.06 4.392c-.413 1.713 1.472 3.067 2.992 2.149L12 19.35l3.897 2.354c1.52.918 3.405-.436 2.992-2.15l-1.06-4.39 3.468-2.938c1.353-1.146.633-3.336-1.142-3.477l-4.552-.36-1.754-4.17Z" />
                </svg>
              </div>
            </ng-container>
          </div>
        </div>
        <p style="color: rgb(88, 88, 88); font-size: 14px;">{{review.createdAt | date:'dd/MM/yyyy HH:mm'}}</p>
        <div>
          <ng-container *ngIf="review.comment.length > 250">
            <div *ngIf="!review.isExpanded">
              <span>{{ review.comment | slice:0:250 }}...</span>
              <a (click)="toggleComment(review)" class="show-more-less"> Mostrar mais</a>
            </div>
        
            <div *ngIf="review.isExpanded">
              <span>{{ review.comment }}</span>
              <a (click)="toggleComment(review)" class="show-more-less"> Mostrar menos</a>
            </div>
        
          </ng-container>
        
          <span *ngIf="review.comment.length <= 250">
            {{ review.comment }}
          </span>
        </div>
      </div>
    </div>
  </div>

</div>
